/*
 * ====================================================================
 *  AppMgr.cpp
 *
 * Copyright (c) 2005-2007 Nokia Corporation
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 * ====================================================================
 */

#include <f32file.h>
#include <eikenv.h>
#include <eikappui.h>
#include <AppMgr.rsg>
#include "Python_appui.h"
#include "AppMgr.h"
#ifdef EKA2
#include <eikstart.h>
#endif /*EKA2*/

const TUid KUidAppMgrApp = { ${{PYS60_UID_APPMGR}} };
_LIT(KInboxSubPath, "\\System\\Mail\\");
_LIT(KDefaultScript, "default.py");
#ifdef EKA2
// XXX change me
_LIT(KFullScript, "c:\\private\\${{PYS60_UID_APPMGR[2:]}}\\default.py");
#endif

CEikAppUi* CAppMgrDocument::CreateAppUiL() 
{
  CEikAppUi* appui = CreateAmarettoAppUi(R_APPMGR_EXTENSION_MENU);
  if (!appui)
    User::Leave(KErrNoMemory);
  return appui;
}

CFileStore* CAppMgrDocument::OpenFileL(TBool /*aDoOpen*/, const TDesC& aFileName, RFs& /*aFs*/)
{
  //  if (aFileName.Find(KInboxSubPath) != KErrNotFound) {

#ifdef EKA2
  (STATIC_CAST(CAmarettoAppUi*, CEikonEnv::Static()->EikAppUi()))->RunScriptL(KFullScript, &aFileName);
#else
  TFileName appName = Application()->AppFullName();
  TParse p;
  p.Set(KDefaultScript, &appName, NULL);
  (STATIC_CAST(CAmarettoAppUi*, CEikonEnv::Static()->EikAppUi()))->RunScriptL(p.FullName(), &aFileName);
#endif /* EKA2 */

  // This would be insecure! Make sure execution always passes through our default.py.
  /*  }
      else
      (STATIC_CAST(CAmarettoAppUi*, CEikonEnv::Static()->EikAppUi()))->RunScriptL(aFileName);
  */
  return NULL;
}

TUid CAppMgrApplication::AppDllUid() const 
{
  return KUidAppMgrApp;
}

CApaDocument* CAppMgrApplication::CreateDocumentL() 
{
  CAppMgrDocument* document = new (ELeave) CAppMgrDocument(*this);
  return document;
}

EXPORT_C CApaApplication* NewApplication() 
{
  return new CAppMgrApplication;
}

#ifdef EKA2
GLDEF_C TInt E32Main()
	{
	return EikStart::RunApplication(NewApplication);
	}
#endif /*EKA2*/

#ifndef EKA2
GLDEF_C TInt E32Dll(TDllReason) 
{
  return KErrNone;
}
#endif /*EKA2*/
